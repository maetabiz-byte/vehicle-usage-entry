<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>社用車 利用</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    .box {
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 12px;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
    }
    .debug {
      background: #f7f7f7;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h1>社用車 利用</h1>

<div id="debug" class="box debug"></div>
<div id="reservationArea"></div>

<script>
/* ===============================
 * 設定
 * =============================== */
const API_URL = '＜あなたのGASのURL＞';
const RESERVE_OFFSET_MIN = 30; // ★ 予約開始の30分前から有効扱い

/* ===============================
 * ユーティリティ
 * =============================== */
function toDate(str) {
  return new Date(str);
}

function formatDate(d) {
  return d.toISOString().slice(0, 10);
}

function formatDateTime(d) {
  return d.toISOString().slice(0, 16).replace('T', ' ');
}

/* ===============================
 * 予約有効判定
 * =============================== */
function isActiveReservation(res, now) {
  let start = toDate(res.start_time);
  let end   = toDate(res.end_time);

  // 終日予約補正（Google Calendar仕様）
  if (res.is_all_day) {
    end.setDate(end.getDate() - 1);
  }

  // ★ 開始30分前から有効
  start = new Date(start.getTime() - RESERVE_OFFSET_MIN * 60000);

  return start <= now && now <= end;
}

/* ===============================
 * 表示
 * =============================== */
function renderReservation(res) {
  let start = toDate(res.start_time);
  let end   = toDate(res.end_time);

  if (res.is_all_day) {
    end.setDate(end.getDate() - 1);
  }

  let html = `
    <div class="box">
      <div><b>予約内容：</b>${res.job_code} ${res.job_name}</div>
      <div><b>業務コード：</b>${res.job_code}</div>
      <div><b>業務名：</b>${res.job_name}</div>
      <div><b>開始：</b>${res.is_all_day ? formatDate(start) : formatDateTime(start)}</div>
      <div><b>終了：</b>${res.is_all_day ? formatDate(end) : formatDateTime(end)}</div>
      ${res.location ? `<div><b>場所：</b>${res.location}</div>` : ''}
    </div>
    <button onclick="alert('開始処理へ')">開始入力へ</button>
  `;

  document.getElementById('reservationArea').innerHTML = html;
}

function renderNoReservation() {
  document.getElementById('reservationArea').innerHTML =
    '<div class="box error">現在有効な予約はありません</div>';
}

/* ===============================
 * メイン
 * =============================== */
fetch(API_URL)
  .then(r => r.json())
  .then(data => {
    document.getElementById('debug').textContent =
      'DEBUG: JSONP受信成功\n\n' + JSON.stringify(data, null, 2);

    if (!data.reservations || data.reservations.length === 0) {
      renderNoReservation();
      return;
    }

    const now = new Date();

    // 有効な予約を抽出
    const active = data.reservations.filter(r => isActiveReservation(r, now));

    if (active.length === 0) {
      renderNoReservation();
      return;
    }

    // 開始時刻が一番近いものを採用
    active.sort((a, b) => toDate(a.start_time) - toDate(b.start_time));

    renderReservation(active[0]);
  })
  .catch(err => {
    document.getElementById('reservationArea').innerHTML =
      `<div class="box error">取得エラー</div>`;
    console.error(err);
  });
</script>

</body>
</html>
