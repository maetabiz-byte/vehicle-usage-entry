<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>社用車 利用</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 16px; }
    h1 { font-size: 22px; margin-bottom: 12px; }
    .box { border: 1px solid #ccc; padding: 12px; margin-bottom: 12px; }
    .warn { color: red; font-weight: bold; }
    .label { font-weight: bold; }
    pre { font-size: 12px; background: #f7f7f7; padding: 8px; }
  </style>
</head>
<body>

<h1>社用車 利用</h1>
<div id="content"></div>

<script>
/* ===============================
   JSONP callback
   =============================== */
function handleReservation(data) {
  var content = document.getElementById('content');
  var now = new Date();

  // ---- DEBUG 表示（必ず残す）----
  var debugHtml =
    '<div class="box">'
    + '<div class="label">DEBUG: JSONP受信成功</div>'
    + '<pre>' + JSON.stringify(data, null, 2) + '</pre>'
    + '</div>';

  // ---- 有効な予約を1件抽出 ----
  var active = null;

  if (data.reservations && data.reservations.length > 0) {
    for (var i = 0; i < data.reservations.length; i++) {
      var r = data.reservations[i];

      // 終日予約
      if (r.is_all_day === true) {
        // 終日は「今日にかかっていれば有効」とする
        active = r;
        break;
      }

      // 時刻指定予約
      if (r.start_time && r.end_time) {
        var start = new Date(r.start_time);
        var end   = new Date(r.end_time);

        if (start <= now && now < end) {
          active = r;
          break;
        }
      }
    }
  }

  // ---- 表示 ----
  var viewHtml = '<div class="box">';

  if (!active) {
    viewHtml += '<div class="warn">現在有効な予約はありません</div>';
  } else {
    viewHtml += '<div><span class="label">業務コード：</span>' + (active.job_code || '不明') + '</div>';
    viewHtml += '<div><span class="label">業務名：</span>' + (active.job_name || '不明') + '</div>';

    if (active.is_all_day === true) {
      viewHtml += '<div><span class="label">時間：</span>終日</div>';
    } else {
      viewHtml += '<div><span class="label">開始：</span>' + active.start_time + '</div>';
      viewHtml += '<div><span class="label">終了：</span>' + active.end_time + '</div>';
    }

    viewHtml += '<div><span class="label">場所：</span>' + (active.location || '') + '</div>';
    viewHtml += '<div><span class="label">状態：</span>' + (data.usage_state || '') + '</div>';
  }

  viewHtml += '</div>';

  // ---- 反映 ----
  content.innerHTML = debugHtml + viewHtml;
}

/* ===============================
   JSONP 読み込み
   =============================== */
(function () {
  var params = new URLSearchParams(window.location.search);
  var calendarId = params.get('calendar_id');
  var content = document.getElementById('content');

  if (!calendarId) {
    content.innerHTML = '<div class="warn">calendar_id がありません</div>';
    return;
  }

  var GAS_URL =
    'https://script.google.com/macros/s/AKfycbx1IiU6G463iRqi1MQq1EkhEcnJlZra-8ywfQO7WBwX3O2DcsffNIcDc4K0OZZDLGTt/exec';

  var script = document.createElement('script');
  script.src =
    GAS_URL
    + '?calendar_id=' + encodeURIComponent(calendarId)
    + '&callback=handleReservation';

  document.body.appendChild(script);
})();
</script>

</body>
</html>
