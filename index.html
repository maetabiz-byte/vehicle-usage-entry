<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>社用車 利用実績 入力（入口）</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 24px;
    }
    .box {
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 4px;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .ok {
      color: green;
      font-weight: bold;
    }
    button {
      padding: 8px 16px;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <h1>社用車 利用実績 入力（入口）</h1>

  <div class="box">
    <strong>calendar_id :</strong><br>
    <span id="calendar-id-display">(calendar_id がありません)</span>
  </div>

  <div class="box">
    <h2>予約情報（Log参照）</h2>
    <div id="reservation-area">
      <span class="error">URLに calendar_id を付けて開いてください。</span>
    </div>
  </div>

  <div class="box">
    <button id="start-button" disabled>開始入力へ</button>
  </div>

<script>
(function () {

  // ----------------------------
  // 1. URL クエリ取得
  // ----------------------------
  const params = new URLSearchParams(window.location.search);
  const calendarId = params.get('calendar_id');

  const calendarIdDisplay = document.getElementById('calendar-id-display');
  const reservationArea = document.getElementById('reservation-area');
  const startButton = document.getElementById('start-button');

  if (!calendarId) {
    calendarIdDisplay.textContent = '(calendar_id がありません)';
    return;
  }

  calendarIdDisplay.textContent = calendarId;

  // ----------------------------
  // 2. JSONP callback 定義
  // ----------------------------
  window.onReservationLoaded = function (data) {

    if (!data || data.found !== true) {
      reservationArea.innerHTML =
        '<span class="error">現在時刻を含む予約が見つかりません。</span>';
      return;
    }

    // 表示内容
    const html = `
      <div class="ok">予約が見つかりました</div>
      <ul>
        <li><strong>開始：</strong>${data.start_time}</li>
        <li><strong>終了：</strong>${data.end_time}</li>
        <li><strong>業務コード：</strong>${data.job_code ?? '(なし)'}</li>
        <li><strong>業務名：</strong>${data.job_name ?? '(なし)'}</li>
        <li><strong>件名：</strong>${data.title_raw ?? '(なし)'}</li>
        <li><strong>場所：</strong>${data.location ?? '(なし)'}</li>
      </ul>
    `;
    reservationArea.innerHTML = html;

    // ----------------------------
    // 3. start.html へ引き継ぐ
    // ----------------------------
    startButton.disabled = false;

    startButton.onclick = function () {
      const url = new URL('start.html', window.location.href);

      // 必須
      url.searchParams.set('calendar_id', calendarId);

      // プリセット用（存在するもののみ）
      if (data.job_code) url.searchParams.set('job_code', data.job_code);
      if (data.job_name) url.searchParams.set('job_name', data.job_name);

      window.location.href = url.toString();
    };
  };

  // ----------------------------
  // 4. JSONP 呼び出し（script 注入）
  // ----------------------------
  const WEBAPP_URL =
    'https://script.google.com/macros/s/AKfycbx1IiU6G463iRqi1MQq1EkhEcnJlZra-8ywfQO7WBwX3O2DcsffNIcDc4K0OZZDLGTt/exec';

  const script = document.createElement('script');
  script.src =
    WEBAPP_URL +
    '?calendar_id=' + encodeURIComponent(calendarId) +
    '&callback=onReservationLoaded';

  script.onerror = function () {
    reservationArea.innerHTML =
      '<span class="error">予約情報の取得に失敗しました（通信エラー）</span>';
  };

  document.body.appendChild(script);

})();
</script>

</body>
</html>
