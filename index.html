<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>社用車 利用実績（入口）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
<h2>社用車 利用状況</h2>

<div id="status">読込中...</div>
<div id="result"></div>

<script>
/* ===============================
   設定
================================ */
const RESERVATION_SHEET_ID = '1wcrXfS43vpdhTrMtgBQufpXwAps7PF86mcoJsVHYt6s';
const RESERVATION_GID      = '0'; // ← 実際の gid に合わせる
const FEED_URL = `https://spreadsheets.google.com/feeds/list/${RESERVATION_SHEET_ID}/${RESERVATION_GID}/public/values?alt=json`;

/* ===============================
   URL パラメータ
================================ */
const params = new URLSearchParams(location.search);
const calendarId = params.get('calendar_id');

/* ===============================
   メイン
================================ */
fetch(FEED_URL)
  .then(r => r.json())
  .then(json => {
    const rows = json.feed.entry.map(e => ({
      calendar_id: e['gsx$calendarid']?.$t ?? '',
      title:       e['gsx$eventtitle']?.$t ?? '',
      is_deleted:  e['gsx$isdeleted']?.$t ?? 'FALSE',
      is_all_day:  e['gsx$isallday']?.$t ?? 'FALSE',
      start_time:  e['gsx$starttime']?.$t ?? '',
      end_time:    e['gsx$endtime']?.$t ?? '',
      start_date:  e['gsx$startdate']?.$t ?? '',
      end_date:    e['gsx$enddate']?.$t ?? ''
    }));

    render(rows);
  })
  .catch(err => {
    document.getElementById('status').textContent = '取得エラー';
    console.error(err);
  });

/* ===============================
   表示ロジック
================================ */
function render(rows) {
  const now = new Date();
  const today = now.toISOString().slice(0, 10);

  const filtered = rows.filter(r => {
    // 削除済み除外
    if (r.is_deleted !== 'FALSE') return false;

    // calendar_id 完全一致
    if (String(r.calendar_id) !== String(calendarId)) return false;

    // 終日
    if (r.is_all_day === 'TRUE') {
      return r.start_date <= today && today <= r.end_date;
    }

    // 非終日
    const start = new Date(r.start_time);
    const end   = new Date(r.end_time);
    if (isNaN(start) || isNaN(end)) return false;

    return now >= start && now <= end;
  });

  const status = document.getElementById('status');
  const result = document.getElementById('result');

  if (filtered.length === 0) {
    status.textContent = '現在有効な予約はありません';
    return;
  }

  const r = filtered[0];
  status.textContent = '予約中';

  result.innerHTML = `
    <p><strong>${r.title}</strong></p>
    <p>${r.is_all_day === 'TRUE'
      ? `終日（${r.start_date} ～ ${r.end_date}）`
      : `${r.start_time} ～ ${r.end_time}`
    }</p>
  `;
}
</script>
</body>
</html>
