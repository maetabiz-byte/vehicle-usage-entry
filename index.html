<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>社用車 利用</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 16px; }
    h1 { font-size: 20px; }
    .box { border: 1px solid #ccc; padding: 12px; margin-bottom: 12px; }
    .error { color: red; font-weight: bold; }
    .debug { background: #f7f7f7; white-space: pre-wrap; font-family: monospace; }
    button { width: 100%; padding: 12px; font-size: 16px; }
  </style>
</head>
<body>

<h1>社用車 利用</h1>

<div id="debug" class="box debug">DEBUG: 初期状態</div>
<div id="result" class="box">予約取得中…</div>

<script>
/* ===== 設定 ===== */
const GAS_URL =
  "https://script.google.com/macros/s/AKfycbx1IiU6G463iRqi1MQq1EkhEcnJlZra-8ywfQO7WBwX3O2DcsffNIcDc4K0OZZDLGTt/exec";

/* ===== util ===== */
function getCalendarId() {
  return new URLSearchParams(location.search).get("calendar_id");
}

/* ===== JSONP 呼び出し ===== */
(function boot() {
  const calendarId = getCalendarId();
  if (!calendarId) {
    document.getElementById("result").innerHTML =
      '<div class="error">calendar_id がありません</div>';
    return;
  }

  const old = document.getElementById("jsonp-script");
  if (old) old.remove();

  const s = document.createElement("script");
  s.id = "jsonp-script";
  s.src =
    GAS_URL +
    "?calendar_id=" + encodeURIComponent(calendarId) +
    "&callback=handleReservation";

  document.body.appendChild(s);
})();

/* ===== GAS から呼ばれる ===== */
function handleReservation(data) {
  document.getElementById("debug").textContent =
    "DEBUG: JSONP受信成功\n\n" + JSON.stringify(data, null, 2);

  if (!data || !data.reservations || data.reservations.length === 0) {
    document.getElementById("result").innerHTML =
      '<div class="error">予約がありません</div>';
    return;
  }

  const r = data.reservations[0];

  let html = "";
  html += "<div><b>予約内容：</b>" + (r.title_raw || "") + "</div>";
  html += "<div><b>業務コード：</b>" + (r.job_code || "") + "</div>";
  html += "<div><b>業務名：</b>" + (r.job_name || "") + "</div>";
  html += "<div><b>開始：</b>" + (r.start_time || "") + "</div>";
  html += "<div><b>終了：</b>" + (r.end_time || "") + "</div>";
  if (r.location) {
    html += "<div><b>場所：</b>" + r.location + "</div>";
  }

  html += '<div style="margin-top:12px;">';
  html += '<button onclick="goStart()">開始入力へ</button>';
  html += '</div>';

  document.getElementById("result").innerHTML = html;
}

function goStart() {
  const calendarId = getCalendarId();
  if (!calendarId) return;
  location.href = "start.html?calendar_id=" + encodeURIComponent(calendarId);
}
</script>

</body>
</html>
