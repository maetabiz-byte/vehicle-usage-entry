<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>社用車 利用</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 16px; }
    h1 { font-size: 22px; margin-bottom: 12px; }
    .box { border: 1px solid #ccc; padding: 12px; margin-bottom: 12px; }
    .label { font-weight: bold; }
    .warn { color: red; font-weight: bold; }
    pre { font-size: 12px; background: #f7f7f7; padding: 8px; }
  </style>
</head>
<body>

<h1>社用車 利用</h1>
<div id="content"></div>

<script>
/* ===============================
   JSONP callback
   =============================== */
function handleReservation(data) {
  var content = document.getElementById('content');
  var now = new Date();

  /* ---------- DEBUG（残す） ---------- */
  var debugHtml =
    '<div class="box">'
    + '<div class="label">DEBUG</div>'
    + '<pre>' + JSON.stringify(data, null, 2) + '</pre>'
    + '</div>';

  /* ---------- 有効な予約を選択 ---------- */
  var active = null;

  function parseDateOnly(s) {
    var m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    return new Date(+m[1], +m[2] - 1, +m[3], 0, 0, 0, 0);
  }

  var nowTime = now.getTime();
  var today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0).getTime();

  // 1) 時刻指定で「今」
  for (var i = 0; i < (data.reservations || []).length; i++) {
    var r = data.reservations[i];
    if (!r || r.is_all_day) continue;
    if (r.start_time && r.end_time) {
      var st = new Date(r.start_time);
      var et = new Date(r.end_time);
      if (!isNaN(st) && !isNaN(et) && st.getTime() <= nowTime && nowTime < et.getTime()) {
        active = r;
        break;
      }
    }
  }

  // 2) 終日で「今日にかかる」
  if (!active) {
    for (var j = 0; j < (data.reservations || []).length; j++) {
      var a = data.reservations[j];
      if (!a || !a.is_all_day) continue;
      var sd = parseDateOnly(a.start_time);
      var ed = parseDateOnly(a.end_time);
      if (sd && ed && sd.getTime() <= today0 && today0 < ed.getTime()) {
        active = a;
        break;
      }
    }
  }

  /* ---------- 表示 ---------- */
  var viewHtml = '<div class="box">';

  if (!active) {
    viewHtml += '<div class="warn">現在有効な予約はありません</div>';
  } else {

    /* ===== ここが今回の修正ポイント ===== */

    // 表示用 start / end を作る
    var dispStart = active.start_time;
    var dispEnd   = active.end_time;

    // 終日の場合だけ、end を表示用に −1 日
    if (active.is_all_day === true && active.end_time) {
      var m = String(active.end_time).match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) {
        var d = new Date(+m[1], +m[2] - 1, +m[3], 0, 0, 0, 0);
        d.setDate(d.getDate() - 1);
        var y = d.getFullYear();
        var mm = ('0' + (d.getMonth() + 1)).slice(-2);
        var dd = ('0' + d.getDate()).slice(-2);
        dispEnd = y + '-' + mm + '-' + dd;
      }
    }

    /* ===== ここまで ===== */

    // 予約内容
    var title = active.title_raw || '';
    if (!title) {
      var jc = active.job_code || '';
      var jn = active.job_name || '';
      title = jc && jn ? jc + '｜' + jn : (jc || jn);
    }

    viewHtml += '<div><span class="label">予約内容：</span>' + title + '</div>';
    viewHtml += '<div><span class="label">開始日：</span>' + dispStart + '</div>';
    viewHtml += '<div><span class="label">終了日：</span>' + dispEnd + '</div>';

    if (active.location) {
      viewHtml += '<div><span class="label">場所：</span>' + active.location + '</div>';
    }
  }

  viewHtml += '</div>';

  content.innerHTML = debugHtml + viewHtml;
}

/* ===============================
   JSONP 読み込み
   =============================== */
(function () {
  var params = new URLSearchParams(window.location.search);
  var calendarId = params.get('calendar_id');
  var content = document.getElementById('content');

  if (!calendarId) {
    content.innerHTML = '<div class="warn">calendar_id がありません</div>';
    return;
  }

  var GAS_URL = '（あなたのGASのURL）';

  var script = document.createElement('script');
  script.src =
    GAS_URL
    + '?calendar_id=' + encodeURIComponent(calendarId)
    + '&callback=handleReservation';

  document.body.appendChild(script);
})();
</script>

</body>
</html>
